// src/components/InternAuthPage.jsx

import React, { useState } from 'react';
import styles from '../../components/AuthPage.module.css';
import { useNavigate } from 'react-router-dom';

// Import Firebase functions from your updated firebase.js
import { auth, db } from '../../firebase'; 
import { 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    updateProfile 
} from "firebase/auth";
import { doc, setDoc, getDoc } from 'firebase/firestore'; 

// --- Error Code Translator (Re-included for completeness) ---
const translateFirebaseError = (errorCode) => {
    // ... (unchanged)
    switch (errorCode) {
        case 'auth/invalid-credential':
            return 'âŒ Invalid Credentials. Please check your email and password and try again.';
        case 'auth/email-already-in-use':
            return 'âŒ This email address is already registered.';
        case 'auth/weak-password':
            return 'âŒ Password should be at least 6 characters.';
        default:
            return 'An unexpected error occurred. Please try again.';
    }
};

const InternAuthPage = () => {
    const navigate = useNavigate();

    const [isLoginView, setIsLoginView] = useState(true);
    const [loginData, setLoginData] = useState({ email: '', password: '' });
    
    const [signupData, setSignupData] = useState({ 
        fullname: '', 
        email: '', 
        password: '',
    });
    
    const [message, setMessage] = useState('');

    // Helper function for showing messages
    const showMessage = (text, color = 'red') => {
        setMessage({ text, color });
        setTimeout(() => setMessage(''), 3000); 
    };

    const handleGoBack = () => {
        navigate('/');
    };

    // LOGIN HANDLER (Fetches profile data to confirm type, then redirects)
    const handleLogin = async (e) => {
        e.preventDefault();
        setMessage('');

        try {
            const userCredential = await signInWithEmailAndPassword(auth, loginData.email, loginData.password);
            const user = userCredential.user;

            // CRITICAL: Verify the user is a student/intern before redirecting
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().userType !== 'student') {
                // If the user isn't correctly marked as 'student', log them out and show an error
                auth.signOut();
                showMessage('Login failed. Please use the Company Login page.', 'orange');
                return;
            }

            // ðŸš¨ FIX APPLIED HERE: Redirect to the Intern Dashboard path /intern
            navigate('/intern'); 

        } catch (error) {
            const errorCode = error.code || 'unknown-error'; 
            const userFriendlyMessage = translateFirebaseError(errorCode);
            showMessage(userFriendlyMessage);
        }
    };

    // ... (handleSignup, handleLoginChange, handleSignupChange functions are unchanged)
    const handleSignup = async (e) => {
        e.preventDefault();
        setMessage('');
        const { fullname, email, password } = signupData;

        try {
            // 1. Create user in Firebase Authentication
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Update display name
            await updateProfile(user, { displayName: fullname });

            // 3. Save profile data to Firestore with userType: 'student'
            const userDataToSave = {
                fullname: fullname,
                email: user.email,
                userType: 'student', 
                role: 'intern', 
                isProfileComplete: false,
                createdAt: new Date().toISOString(),
            };
            await setDoc(doc(db, "users", user.uid), userDataToSave);

            showMessage("âœ… Signup successful! Please log in.", "green");
            setSignupData({ fullname: '', email: '', password: '' });
            setIsLoginView(true);

        } catch (error) {
            const errorCode = error.code || 'unknown-error'; 
            const userFriendlyMessage = translateFirebaseError(errorCode);
            showMessage(userFriendlyMessage);
        }
    };

    const handleLoginChange = (e) => {
        setLoginData({ ...loginData, [e.target.id]: e.target.value });
    };

    const handleSignupChange = (e) => {
        setSignupData({ ...signupData, [e.target.id]: e.target.value });
    };


    return (
        // ... (JSX is unchanged)
        <div className={styles.bodyContainer}> 
            <div className={styles.container}>
                
                <button className={styles.backButton} onClick={handleGoBack}>&times;</button>
                
                {/* -------------------- INTERN LOGIN FORM -------------------- */}
                <div 
                    className={`${styles.formBox} ${!isLoginView ? styles.hidden : ''}`}
                >
                    <h2>Intern Login</h2>
                    <form onSubmit={handleLogin}>
                        <div className={styles.inputGroup}>
                            <label htmlFor="login-email">Email</label>
                            <input type="email" id="email" value={loginData.email} onChange={handleLoginChange} required />
                        </div>
                        
                        <div className={styles.inputGroup}>
                            <label htmlFor="login-password">Password</label>
                            <input type="password" id="password" value={loginData.password} onChange={handleLoginChange} required />
                        </div>
                        
                        <button type="submit">Login as Intern</button>
                        
                        <p>
                            Don't have an account? 
                            <button type="button" className={styles.linkButton} onClick={() => setIsLoginView(false)}>
                                Sign up
                            </button> 
                        </p>
                    </form>
                    {message && isLoginView && (<div style={{ color: message.color, marginTop: '10px' }}>{message.text}</div>)}
                </div>

                
                {/* -------------------- INTERN SIGNUP FORM -------------------- */}
                <div 
                    className={`${styles.formBox} ${isLoginView ? styles.hidden : ''}`}
                >
                    <h2>Intern Sign Up</h2>
                    <form onSubmit={handleSignup}>
                        <div className={styles.inputGroup}>
                            <label htmlFor="signup-fullname">Full Name</label>
                            <input type="text" id="fullname" value={signupData.fullname} onChange={handleSignupChange} required />
                        </div>
                        
                        <div className={styles.inputGroup}>
                            <label htmlFor="signup-email">Email</label>
                            <input type="email" id="email" value={signupData.email} onChange={handleSignupChange} required />
                        </div>

                        <div className={styles.inputGroup}>
                            <label htmlFor="signup-password">Password</label>
                            <input type="password" id="password" value={signupData.password} onChange={handleSignupChange} required />
                        </div>

                        <button type="submit">Sign Up as Intern</button>
                        
                        <p>
                            Already have an account? 
                            <button type="button" className={styles.linkButton} onClick={() => setIsLoginView(true)}>
                                Login
                            </button>
                        </p>
                    </form>
                    {message && !isLoginView && (<div style={{ color: message.color, marginTop: '10px' }}>{message.text}</div>)}
                </div>
            </div>
        </div>
    );
}; 

export default InternAuthPage;