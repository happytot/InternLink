// src/components/CompanyAuthPage.jsx

import React, { useState } from 'react';
import styles from '../../components/AuthPage.module.css';
import { useNavigate, Link } from 'react-router-dom';

// Import Firebase functions
import { auth, db } from '../../firebase'; 
import { 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    updateProfile 
} from "firebase/auth";
import { doc, setDoc, getDoc } from 'firebase/firestore'; 

// --- Error Code Translator (Copied from InternAuthPage) ---
const translateFirebaseError = (errorCode) => {
    switch (errorCode) {
        case 'auth/invalid-credential':
            return '❌ Invalid Credentials. Please check your email and password and try again.';
        case 'auth/email-already-in-use':
            return '❌ This email address is already registered.';
        case 'auth/weak-password':
            return '❌ Password should be at least 6 characters.';
        default:
            return 'An unexpected error occurred. Please try again.';
    }
};

const CompanyAuthPage = () => {
    const navigate = useNavigate();

    const [isLoginView, setIsLoginView] = useState(true);
    const [loginData, setLoginData] = useState({ email: '', password: '' });
    
    const [signupData, setSignupData] = useState({ 
        companyName: '', // Company signup needs a name field
        email: '', 
        password: '',
    });
    
    const [message, setMessage] = useState('');

    // Helper function for showing messages
    const showMessage = (text, color = 'red') => {
        setMessage({ text, color });
        setTimeout(() => setMessage(''), 3000); 
    };

    const handleGoBack = () => {
        navigate('/');
    };

    // LOGIN HANDLER (Verifies 'company' type, then redirects to /company)
    const handleLogin = async (e) => {
        e.preventDefault();
        setMessage('');

        try {
            const userCredential = await signInWithEmailAndPassword(auth, loginData.email, loginData.password);
            const user = userCredential.user;

            // CRITICAL: Verify the user is a COMPANY before redirecting
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().userType !== 'company') {
                // If the user isn't correctly marked as 'company', log them out and show an error
                auth.signOut();
                showMessage('Login failed. Please use the Intern Login page.', 'orange');
                return;
            }

            // Redirect to the Company Dashboard path
            navigate('/company'); 

        } catch (error) {
            const errorCode = error.code || 'unknown-error'; 
            const userFriendlyMessage = translateFirebaseError(errorCode);
            showMessage(userFriendlyMessage);
        }
    };

    // SIGNUP HANDLER (Saves 'company' type to Firestore)
    const handleSignup = async (e) => {
        e.preventDefault();
        setMessage('');
        const { companyName, email, password } = signupData;

        try {
            // 1. Create user in Firebase Authentication
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Update display name (using companyName for display name)
            await updateProfile(user, { displayName: companyName });

            // 3. Save profile data to Firestore with userType: 'company'
            const userDataToSave = {
                companyName: companyName,
                email: user.email,
                userType: 'company', // <-- CRITICAL: Set user type
                role: 'employer', 
                isProfileComplete: false,
                createdAt: new Date().toISOString(),
            };
            await setDoc(doc(db, "users", user.uid), userDataToSave);

            showMessage(`✅ Signup successful for ${companyName}! Please log in.`, "green");
            setSignupData({ companyName: '', email: '', password: '' });
            setIsLoginView(true);

        } catch (error) {
            const errorCode = error.code || 'unknown-error'; 
            const userFriendlyMessage = translateFirebaseError(errorCode);
            showMessage(userFriendlyMessage);
        }
    };

    // Handlers
    const handleLoginChange = (e) => {
        setLoginData({ ...loginData, [e.target.id]: e.target.value });
    };

    const handleSignupChange = (e) => {
        // Uses 'companyName' key for the input ID/name
        setSignupData({ ...signupData, [e.target.id]: e.target.value }); 
    };

    return (
        <div className={styles.bodyContainer}> 
            <div className={styles.container}>
                
                <button className={styles.backButton} onClick={handleGoBack}>&times;</button>
                
                {/* -------------------- COMPANY LOGIN FORM -------------------- */}
                <div 
                    className={`${styles.formBox} ${!isLoginView ? styles.hidden : ''}`}
                >
                    <h2>Company Login</h2>
                    <form onSubmit={handleLogin}>
                        <div className={styles.inputGroup}>
                            <label htmlFor="email">Email</label>
                            <input type="email" id="email" value={loginData.email} onChange={handleLoginChange} required />
                        </div>
                        
                        <div className={styles.inputGroup}>
                            <label htmlFor="password">Password</label>
                            <input type="password" id="password" value={loginData.password} onChange={handleLoginChange} required />
                        </div>
                        
                        <button type="submit">Login as Company</button>
                        
                        <p>
                            Don't have an account? 
                            <button type="button" className={styles.linkButton} onClick={() => setIsLoginView(false)}>
                                Sign up
                            </button> 
                        </p>
                    </form>
                    {message && isLoginView && (<div style={{ color: message.color, marginTop: '10px' }}>{message.text}</div>)}
                </div>

                
                {/* -------------------- COMPANY SIGNUP FORM -------------------- */}
                <div 
                    className={`${styles.formBox} ${isLoginView ? styles.hidden : ''}`}
                >
                    <h2>Company Sign Up</h2>
                    <form onSubmit={handleSignup}>
                        <div className={styles.inputGroup}>
                            <label htmlFor="companyName">Company Name</label>
                            <input type="text" id="companyName" value={signupData.companyName} onChange={handleSignupChange} required />
                        </div>
                        
                        <div className={styles.inputGroup}>
                            <label htmlFor="email">Email</label>
                            <input type="email" id="email" value={signupData.email} onChange={handleSignupChange} required />
                        </div>

                        <div className={styles.inputGroup}>
                            <label htmlFor="password">Password</label>
                            <input type="password" id="password" value={signupData.password} onChange={handleSignupChange} required />
                        </div>

                        <button type="submit">Sign Up as Company</button>
                        
                        <p>
                            Already have an account? 
                            <button type="button" className={styles.linkButton} onClick={() => setIsLoginView(true)}>
                                Login
                            </button>
                        </p>
                    </form>
                    {message && !isLoginView && (<div style={{ color: message.color, marginTop: '10px' }}>{message.text}</div>)}
                </div>


            </div>
        </div>
    );
}; 

export default CompanyAuthPage;